<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cardex - Valoración Ponderada</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f0f0f0;
    }
    .menu-icons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      padding: 50px 20px;
    }
    .menu-icons img {
      width: 150px;
      height: 150px;
      cursor: pointer;
      border-radius: 10px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .menu-icons img:hover {
      transform: scale(1.05);
    }
    section {
      display: none;
      padding: 20px;
    }
    section.active {
      display: block;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #d9d9d9;
    }
    input, select {
      margin: 5px;
      padding: 5px;
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      background-color: #007acc;
      color: white;
      border: none;
      cursor: pointer;
    }
    .t-account {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .t-box {
      border: 1px solid #333;
      width: 180px;
      padding: 10px;
      background: white;
    }
    .t-box h4 {
      text-align: center;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .t-box p {
      margin: 4px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="menu-icons">
    <img src="AgregarOperacion.png" alt="Ingresar Operación" onclick="mostrar('operacion')">
    <img src="ValoracionPonderada.png" alt="Valoración" onclick="mostrar('valoracion')">
    <img src="RegistroOperaciones.png" alt="Registro" onclick="mostrar('registro')">
    <img src="StockMercancia.png" alt="Stock" onclick="mostrar('stock')">
    <img src="UtilidadBruta.png" alt="Utilidad" onclick="mostrar('utilidad')">
  </div>

  <section id="operacion" class="active">
    <h2>Ingresar Operación</h2>
    <form id="form">
      <input type="text" id="fecha" placeholder="Fecha">
      <select id="tipo" onchange="ajustarPrecio(this.value)">
        <option>Inventario inicial</option>
        <option>Compra</option>
        <option>Venta</option>
        <option>Devolución sobre venta</option>
        <option>Devolución sobre compra</option>
      </select>
      <input type="text" id="descripcion" placeholder="Descripción">
      <input type="number" id="cantidad" placeholder="Cantidad">
      <input type="number" id="precio" placeholder="Precio Unitario" readonly>
      <button type="submit">Agregar</button>
    </form>
  </section>

  <section id="valoracion">
    <h2>Tabla de Valoración Ponderada</h2>
    <table id="tabla">
      <thead>
        <tr>
          <th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Cantidad</th><th>C.U</th><th>Total</th><th>Existencias</th><th>Valor Final</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="registro">
    <h2>Registro de Operaciones (Cuentas T)</h2>
    <div class="t-account" id="cuentasT"></div>
  </section>

  <section id="stock">
    <h2>Stock de Mercancía</h2>
    <p id="stockInfo">No hay datos aún.</p>
  </section>

  <section id="utilidad">
    <h2>Utilidad Bruta</h2>
    <p id="utilidadInfo">No hay datos aún.</p>
  </section>

  <script>
    let existencias = 0;
    let valorFinal = 0;
    let ventasTotales = 0;
    let costoDeVentas = 0;

    const form = document.getElementById('form');
    const tabla = document.querySelector('#tabla tbody');
    const cuentasT = document.getElementById('cuentasT');
    const precioInput = document.getElementById('precio');
    const tipoInput = document.getElementById('tipo');
    const cantidadInput = document.getElementById('cantidad');

    let cuentas = {
      Capital: [],
      Caja: [],
      Banco: [],
      Almacen: [],
      Proveedores: [],
      Ventas: [],
      'Costo de Ventas': [],
      'Devolución / Compra': [],
      'Devolución / Venta': []
    };

    function ajustarPrecio(tipo) {
      const esAutomatico = tipo === "Venta" || tipo === "Devolución sobre venta";
      if (esAutomatico && existencias > 0) {
        const promedio = valorFinal / existencias;
        precioInput.value = promedio.toFixed(2);
      } else {
        precioInput.value = "";
      }
      precioInput.readOnly = esAutomatico;
    }

    function agregarMovimiento(cuenta, valor) {
      cuentas[cuenta] = cuentas[cuenta] || [];
      cuentas[cuenta].push(valor);
    }

    function actualizarCuentas() {
      cuentasT.innerHTML = '';
      for (const cuenta in cuentas) {
        const div = document.createElement('div');
        div.className = 't-box';
        div.innerHTML = `<h4>${cuenta}</h4>` + cuentas[cuenta].map(val => `<p>${val}</p>`).join('');
        cuentasT.appendChild(div);
      }
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      const fecha = document.getElementById('fecha').value;
      const tipo = tipoInput.value;
      const descripcion = document.getElementById('descripcion').value;
      const cantidad = parseFloat(cantidadInput.value);
      let precio = parseFloat(precioInput.value);

      if ((tipo === "Venta" || tipo === "Devolución sobre compra") && cantidad > existencias) {
        alert("No puedes realizar esta operación: cantidad supera las existencias disponibles.");
        return;
      }

      const esEntrada = tipo === "Compra" || tipo === "Inventario inicial" || tipo === "Devolución sobre venta";
      const esSalida = tipo === "Venta" || tipo === "Devolución sobre compra";

      let total = 0;
      if (esEntrada) {
        total = cantidad * precio;
        existencias += cantidad;
        valorFinal += total;
        if (tipo === "Compra") {
          agregarMovimiento("Almacen", `+$${total}`);
          agregarMovimiento("Proveedores", `+$${total}`);
        } else if (tipo === "Inventario inicial") {
          agregarMovimiento("Almacen", `+$${total}`);
          agregarMovimiento("Capital", `+$${total}`);
        } else if (tipo === "Devolución sobre venta") {
          agregarMovimiento("Almacen", `+$${total}`);
          agregarMovimiento("Devolución / Venta", `+$${total}`);
        }
      } else if (esSalida) {
        precio = valorFinal / existencias;
        total = cantidad * precio;
        ventasTotales += (tipo === "Venta") ? cantidad * precio : 0;
        costoDeVentas += total;
        existencias -= cantidad;
        valorFinal -= total;
        if (tipo === "Venta") {
          agregarMovimiento("Ventas", `+$${cantidad * precio}`);
          agregarMovimiento("Costo de Ventas", `+$${total}`);
          agregarMovimiento("Almacen", `-$${total}`);
        } else if (tipo === "Devolución sobre compra") {
          agregarMovimiento("Almacen", `-$${total}`);
          agregarMovimiento("Devolución / Compra", `+$${total}`);
        }
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${fecha}</td><td>${tipo}</td><td>${descripcion}</td><td>${cantidad}</td><td>$${precio.toFixed(2)}</td><td>$${(cantidad * precio).toFixed(2)}</td><td>${existencias}</td><td>$${valorFinal.toFixed(2)}</td>
      `;
      tabla.appendChild(row);

      document.getElementById('stockInfo').innerText = `Cantidad: ${existencias} unidades | Valor: $${valorFinal.toFixed(2)}`;
      document.getElementById('utilidadInfo').innerText = `Ventas netas: $${ventasTotales.toFixed(2)} | Costo de ventas: $${costoDeVentas.toFixed(2)} | Utilidad bruta: $${(ventasTotales - costoDeVentas).toFixed(2)}`;

      actualizarCuentas();
      form.reset();
      ajustarPrecio(tipoInput.value);
    });

    function mostrar(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
  </script>
</body>
</html>
