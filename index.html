<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>HatYork - Sistema de Control de Inventarios</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2, h3 { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, select { width: 100%; padding: 6px; box-sizing: border-box; }
    button { margin-top: 10px; padding: 8px 12px; cursor: pointer; }
    nav a { display: block; margin-bottom: 5px; color: #0366d6; text-decoration: none; }
  </style>
</head>
<body>
  <h2>HatYork - Sistema de Control de Inventarios</h2>
  <nav>
    <a href="#introduccion">Introducción</a>
    <a href="#operaciones">Método Perpetuo</a>
    <a href="#peps">Valoración Ponderada</a>
    <a href="#stock">Stock de Mercancía</a>
    <a href="#utilidad">Utilidad Bruta</a>
    <a href="#conclusion">Conclusión</a>
  </nav>

  <h3 id="tablaResultado"></h3>

  [⚠️ Suspicious Content] <script>
    function mostrarTabla() {
      const metodo = document.querySelector('input[name="metodo"]:checked');
      if (!metodo) return alert("Seleccione un método");

      let html = "";
      if (metodo.value === "VALORACION") {
        html += `
          <h3>Valoración ponderada</h3>
          <table id="tablaValoracion">
            <tr>
              <th>Fecha</th><th>Operación</th><th>Descripción</th><th>Cantidad</th>
              <th>Precio Unitario</th><th>Total</th><th>Costo de Ventas</th>
              <th>Existencias</th><th>Valor Final</th>
            </tr>
            ${filaValoracion()}
          </table>
          <button onclick="agregarFilaValoracion()">+ Añadir fila</button>
        `;
      } else {
        html += `<p>Modo no soportado aún</p>`;
      }
      document.getElementById("tablaResultado").innerHTML = html;
      agregarCalculos();
    }

    function filaValoracion() {
      return `<tr>
        <td><input type="date"></td>
        <td>
          <select>
            <option>Compra</option>
            <option>Venta</option>
            <option>Devolución sobre compra</option>
            <option>Devolución sobre venta</option>
            <option>Inventario inicial</option>
          </select>
        </td>
        <td><input type="text"></td>
        <td><input type="number" class="cantidad"></td>
        <td><input type="number" class="precio"></td>
        <td><input type="number" class="total" readonly></td>
        <td><input type="number" class="costo"></td>
        <td><input type="number" class="existencia"></td>
        <td><input type="number" class="valorFinal" readonly></td>
      </tr>`;
    }

    function agregarFilaValoracion() {
      document.getElementById("tablaValoracion").insertAdjacentHTML('beforeend', filaValoracion());
      agregarCalculos();
    }

    function agregarCalculos() {
      const rows = document.querySelectorAll("#tablaValoracion tr");
      rows.forEach(row => {
        row.querySelectorAll("input, select").forEach(input => {
          input.addEventListener("input", () => calcularValoracion());
        });
      });
    }

    function calcularValoracion() {
      const rows = document.querySelectorAll("#tablaValoracion tr");
      let acumuladoExistencias = 0;
      let acumuladoValorFinal = 0;
      let ultimoPrecioUnitario = 0;

      rows.forEach((row, index) => {
        if (index === 0) return;
        const cantidad = parseFloat(row.querySelector(".cantidad")?.value || 0);
        const precioInput = row.querySelector(".precio");
        let precio = parseFloat(precioInput?.value || 0);
        const operacion = row.querySelector("select")?.value;
        const totalField = row.querySelector(".total");
        const existenciaField = row.querySelector(".existencia");
        const valorFinalField = row.querySelector(".valorFinal");

        if (["Venta", "Devolución sobre compra", "Devolución sobre venta"].includes(operacion)) {
          if (precioInput && ultimoPrecioUnitario > 0) {
            precioInput.value = ultimoPrecioUnitario.toFixed(2);
            precio = ultimoPrecioUnitario;
          }
        }

        const total = cantidad * precio;
        if (totalField) totalField.value = total.toFixed(2);

        if (["Inventario inicial", "Compra", "Devolución sobre venta"].includes(operacion)) {
          acumuladoExistencias += cantidad;
          acumuladoValorFinal += total;
        } else if (["Venta", "Devolución sobre compra"].includes(operacion)) {
          acumuladoExistencias -= cantidad;
          acumuladoValorFinal -= total;
        }

        if (existenciaField) existenciaField.value = acumuladoExistencias;
        if (valorFinalField) valorFinalField.value = acumuladoValorFinal.toFixed(2);

        if (["Inventario inicial", "Compra"].includes(operacion) && cantidad > 0) {
          ultimoPrecioUnitario = precio;
        }

        if (operacion === "Venta" && cantidad > 0 && acumuladoExistencias > 0) {
          const precioUnitario = acumuladoValorFinal / acumuladoExistencias;
          ultimoPrecioUnitario = precioUnitario;
          if (precioInput) precioInput.value = precioUnitario.toFixed(2);
          if (totalField) totalField.value = (cantidad * precioUnitario).toFixed(2);
        }
      });
    }
  </script>
</body>
</html>
